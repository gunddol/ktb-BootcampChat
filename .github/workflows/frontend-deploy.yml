name: Frontend Deployment

on:
  push:
    branches: [main]
    paths:
      - 'apps/frontend/**'
      - 'deployment-scripts/deploy-frontend-ci.sh'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    name: S3/CloudFront ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: Node.js ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: apps/frontend
        run: npm ci
      
      - name: production env íŒŒì¼ ìƒì„±
        working-directory: apps/frontend
        run: |
          cat > .env.production << EOF
          NEXT_PUBLIC_API_URL=https://api.chat.goorm-ktb-015.goorm.team
          NEXT_PUBLIC_SOCKET_URL=https://api.chat.goorm-015.goorm.team
          NODE_ENV=production
          EOF
      
      - name: Next.js ë¹Œë“œ
        working-directory: apps/frontend
        run: |
          # next.config.js - S3 export ì„¤ì •
          cat > next.config.js << 'EOF'
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            reactStrictMode: false,
            transpilePackages: ['@vapor-ui/core', '@vapor-ui/icons'],
            output: 'export',
            images: { unoptimized: true },
            trailingSlash: true,
            compress: true,
          };
          module.exports = nextConfig;
          EOF
          
          npm run build
      
      - name: AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: S3 frontend ë°°í¬
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        working-directory: apps/frontend
        run: |
          # Upload all files with long cache
          aws s3 sync out/ s3://$S3_BUCKET/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --region $AWS_REGION
          
          # Override HTML files with no cache
          aws s3 sync out/ s3://$S3_BUCKET/ \
            --exclude "*" \
            --include "*.html" \
            --cache-control "public, max-age=0, must-revalidate" \
            --region $AWS_REGION
          
          echo "âœ… S3 upload complete"
      
      - name: CloudFront ë¬´íš¨í™”
        env:
          DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --region $AWS_REGION
          
          echo "âœ… CloudFront cache invalidated"
      
      - name: ë°°í¬ í™•ì¸
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          # Wait for CloudFront invalidation
          sleep 10
          
          # Test S3 website URL
          WEBSITE_URL="http://$S3_BUCKET.s3-website.$AWS_REGION.amazonaws.com"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $WEBSITE_URL)
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "âœ… S3 website is accessible (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸  S3 website returned HTTP $HTTP_CODE"
          fi
          
          # Test production URL
          PROD_URL="https://chat.goorm-ktb-015.goorm.team"
          PROD_CODE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL)
          
          if [ "$PROD_CODE" == "200" ]; then
            echo "âœ… Production site is accessible (HTTP $PROD_CODE)"
          else
            echo "âš ï¸  Production site returned HTTP $PROD_CODE"
          fi
      
      - name: ë°°í¬ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Frontend deployment successful!"
            echo "ðŸ”— URL: https://chat.goorm-ktb-015.goorm.team"
          else
            echo "âŒ Frontend deployment failed!"
          fi
